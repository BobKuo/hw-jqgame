<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.5/css/bootstrap.css' />
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    html,
    body {
      width: 100vw;
      height: 100vh;
    }

    #game {
      border: 1px solid red;
      height: 100%;
      padding: 0;

      position: relative;
    }

    .bg-color1 {
      background-color: #ff5959;
    }

    .bg-color2 {
      background-color: #facf5a;
    }

    .bg-color3 {
      background-color: #49beb7;
    }

    .bg-color4 {
      background-color: #085f63;
    }

    .ball-1 {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: #ff5959;
      color: white;
      border: 1px solid black;

      line-height: 100px;
      font-size: 3rem;
    }

    .ball-2 {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: #facf5a;
      color: white;
      border: 1px solid black;

      line-height: 80px;
      font-size: 2rem;
    }

    .ball-3 {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #49beb7;
      color: white;
      border: 1px solid black;

      line-height: 60px;
    }

    .ball-4 {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #085f63;
      color: white;
      border: 1px solid black;

      line-height: 40px;
    }

    .target {
      position: absolute;

      text-align: center;

      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
    }

    .place {
      border: 1px solid #000;
    }

    /* .place-1 {
      position: absolute;

      width: 400px;
      height: 400px;

      background-color: #ff5959;
    } */

    #game-menu {
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1;
    }

    #score-board {
      position: fixed;
      bottom: 0;
      left: 0;
      z-index: 1;
    }
  </style>
</head>

<body>

  <div id="game-menu" class="btn-group">
    <input type="radio" class="btn-check" name="btnradio" id="btnradio1" autocomplete="off" checked>
    <label class="btn btn-outline-primary" for="btnradio1">Radio 1</label>

    <input type="radio" class="btn-check" name="btnradio" id="btnradio2" autocomplete="off">
    <label class="btn btn-outline-primary" for="btnradio2">Radio 2</label>

    <input type="radio" class="btn-check" name="btnradio" id="btnradio3" autocomplete="off">
    <label class="btn btn-outline-primary" for="btnradio3">Radio 3</label>

    <input type="button" value="開始" id="btn-start">

  </div>

  <div id="score-board">
    <p>分數: <span id="text-score">0</span></p>
    <p>剩餘: <span id="text-time">0</span></p>

  </div>


  <div id="game" class="container">

    <div class="row w-100 h-100 g-0 align-items-center position-absolute">
      <div class="place col-3 h-25 bg-color1"></div>
      <div class="place col-3 h-25 bg-color2"></div>
      <div class="place col-3 h-25 bg-color3"></div>
      <div class="place col-3 h-25 bg-color4"></div>
    </div>

    <!-- <div class="place place-1"></div>
    <div class="place place-2"></div>
    <div class="place place-3"></div>
    <div class="place place-4"></div> -->

  </div>


  <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.js'></script>
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/gsap.min.js"></script>
  <script>
    const game_width = $('#game').width()
    const game_height = $('#game').height()

    const life_time = 10
    const ball_catogory = ['ball-1', 'ball-2', 'ball-3', 'ball-4']

    const computeDropTime = (height) => {
      return Math.sqrt(height / 50)
    }

    const dropBall = () => {

      const randomIndex = Math.floor(Math.random() * ball_catogory.length)
      const randomClass = ball_catogory[randomIndex]

      const ball = $('<div class="target"></div>').addClass(randomClass)
      ball.data('typeIdx', randomIndex)

      $('#game').append(ball)

      // 初始位置
      const ball_size = parseInt(ball.css('width'))
      const drop_height = game_height - ball_size

      const initial_x = Math.floor(Math.random() * (game_width - ball_size));

      gsap.set(ball, {
        x: initial_x,
        y: 0
      })

      // 倒數器
      let lifeTimeLeft = life_time
      ball.text(lifeTimeLeft)
      const ballTimer = setInterval(() => {
        lifeTimeLeft--
        if (lifeTimeLeft >= 0) {
          ball.text(lifeTimeLeft)
        }
        if (lifeTimeLeft <= 0) {
          clearInterval(ballTimer)
          ball.fadeOut(200, function () {
            // 懲罰
            const ball_score = 4 - ball.data('typeIdx')
            score -= ball_score
            $('#text-score').text(score);
            //
            $(this).remove()
          })
        }
      }, 1000)

      console.log('drop_height', drop_height)

      gsap
        .to(ball, {
          y: drop_height,
          duration: computeDropTime(drop_height),
          ease: "bounce.out"
        })
    }







    // 遊戲設定
    const GAME_TIME = 60
    const DROP_INTERVAL = 1

    // 分數
    let score = 0
    // 剩餘時間
    let timeLeft = 0
    // 計時器
    let timer = 0
    // 最高分
    const highscore = {
      name: '-',
      score: 0
    }
    // 拖曳物件
    let draggingObj = null;

    // 遊戲開始
    $('#btn-start').on('click', function () {
      // 停用按鈕
      $(this).attr('disabled', true)
      // 重設分數
      score = 0
      $('#text-score').text(score)
      // 重設遊戲時間
      timeLeft = GAME_TIME
      $('#text-time').text(timeLeft)


      const _this = this
      timer = setInterval(function () {
        // 倒數
        timeLeft--
        $('#text-time').text(timeLeft)

        // 時間到
        if (timeLeft == 0) {
          // 停止計時器
          clearInterval(timer)
          clearInterval(drop_timer)

          // 啟用開始按鈕
          $(_this).attr('disabled', false)
          // 清空區域
          $('.target').remove()

          //
          draggingObj = null
        }
      }, 1000)

      let drop_timer = setInterval(dropBall, DROP_INTERVAL * 1000)
      dropBall()
    })







    //
    $('#game').on('mousedown', '.target', function (e) {
      draggingObj = $(this)

      // 取得滑鼠點擊位置與球左上角的距離
      draggingObj.data('offsetX', e.clientX - this.getBoundingClientRect().left)
      draggingObj.data('offsetY', e.clientY - this.getBoundingClientRect().top)

      // 顯示在最上層
      draggingObj.css('z-index', 999)

      //
      gsap.killTweensOf(draggingObj)
    })

    //
    $(document).on('mousemove', function (e) {
      if (!draggingObj) return

      // 計算新位置（相對於 container）
      const gameRect = $('#game')[0].getBoundingClientRect()
      let x = e.clientX - gameRect.left - draggingObj.data('offsetX')
      let y = e.clientY - gameRect.top - draggingObj.data('offsetY')

      // 限制在 container 內
      const ball_size = parseInt(draggingObj.css('width'))
      x = Math.max(0, Math.min(x, game_width - ball_size))
      y = Math.max(0, Math.min(y, game_height - ball_size))

      gsap.set(draggingObj[0], { x, y })
    })

    //
    $(document).on('mouseup', function () {
      if (!draggingObj) return

      // 取得 ball 和 place 的位置
      const ball_score = draggingObj.data('typeIdx') + 1
      const objRect = draggingObj[0].getBoundingClientRect();
      const placeRect = $('.place')[draggingObj.data('typeIdx')].getBoundingClientRect();

      // 判斷是否有重疊
      const isInside =
        objRect.left >= placeRect.left &&
        objRect.right <= placeRect.right &&
        objRect.top >= placeRect.top &&
        objRect.bottom <= placeRect.bottom;

      if (isInside) {
        // 球消失
        draggingObj.remove();
        // 增加分數
        score += ball_score;
        $('#text-score').text(score);
      } else {

        draggingObj.css('z-index', '');
        // 取得目前 y
        const currentY = gsap.getProperty(draggingObj[0], 'y');
        // 重新啟動動畫，從目前 y 掉到底部

        // (drop_height - currentY) / drop_height * life_time

        const ball_size = parseInt(draggingObj.css('width'))
        const drop_height = game_height - ball_size

        gsap.to(draggingObj[0], {
          y: drop_height,
          duration: computeDropTime(drop_height - currentY), // 依剩餘距離調整動畫時間
          ease: "bounce.out"
        });
      }
      draggingObj = null; // 拖曳結束，重置
    });
  </script>
</body>

</html>